---
config:
  theme: 'dark'
---

flowchart TD
    U[User via Telegram] --> TG[Telegram API]

    subgraph VPS[Host Server VPS]
        subgraph Docker[Docker Compose Environment]
            direction TB

            NGINX[NGINX SSL / Routing]

            subgraph BotProcess[Telegram Bot Service]
                BOT[Bot Main Process]
                subgraph BotCore[Bot Components]
                    AUTH[Auth Middleware]
                    SUBCHECK[Subscription Middleware]
                    ROUTER[Handlers / Router]
                    ERROR[Error Handler]
                    LOG[Logging]
                end
                BOT --> AUTH
                BOT --> SUBCHECK
                BOT --> ROUTER
                BOT --> ERROR
                BOT --> LOG
            end

            subgraph BackendProcess[FastAPI Backend Service]
                API[Backend API]
                subgraph BackendCore[Backend Layers]
                    ROUTES[Routes Layer]
                    SERVICES[Core Services]
                    AGENT[AI Orchestration / Agent]
                end
                API --> ROUTES
                ROUTES --> SERVICES
                SERVICES --> AGENT
            end

            subgraph Data[PostgreSQL Database]
                DB[(PostgreSQL)]
            end
        end
    end

    %% Connections
    TG --> NGINX
    NGINX --> BOT
    NGINX --> API
    AUTH --> DB
    SUBCHECK --> DB
    SERVICES --> DB
    LOG --> DB

    AGENT --> AI[AI Services]
    AI --> ChatGPT[ChatGPT API]
    AI --> DeepSeek[DeepSeek API]
    AI --> Perplexity[Perplexity API]