# Помощник-бот (Помогатор)

#### 1. Цель  
Создать Telegram-бота, который позволит пользователям взаимодействовать с рядом AI-ассистентов: ChatGPT, Perplexity и DeepSeek.

#### 2. Бизнес-логика  

Пользователь будет взаимодействовать с приложением через Telegram-бота.  

Начало работы — с inline-кнопки `/start`. Пользователю будут доступны inline-кнопки, которые позволят:  
- `/start` (начать диалог с ИИ)  
- `/status` (покажет, является ли пользователь VIP или нет)  
- `/help` (стандартное справочное сообщение)  
- `/settings` (можно проверить профиль и информацию о VIP-статусе)  
- `/model` (выбрать между ChatGPT: (Instant, Thinking, GPT-5), Perplexity: (Search, Research, Laboratory) и DeepSeek: (Standard, Thinking))  

В бесплатной версии будет ограниченное количество разрешённых сообщений (10), а в VIP-версии (с ежемесячной подпиской) — не будет.  

Основная бизнес-логика визуализирована здесь:

![alt text](images/user_to_answ_flow2.png)

#### 3. Архитектура и стек   

![alt text](<images/system architecture.png>)

Планируется упаковать проект в Docker Compose/Docker.  

**Язык:** Python  
**Телеграм-бот:** Aiogram (асинхронность, FSM, промежуточное ПО, инлайн-кнопки).  
**Backend API:** FastAPI (REST API для обработки сообщений и бизнес-логики).  
**AI / LLM:**  
- OpenAI API (ChatGPT).  
- Perplexity API.  
- DeepSeek API.  
**База данных:** PostgreSQL (пользователи, сообщения, кредиты, подписки, платежи).  
**ORM и миграции:**  
- SQLAlchemy.  
- Alembic.  
**Платежи:** API платежного провайдера (обработка платежей и webhook).  
**Инфраструктура:** Docker, Docker Compose, NGINX (SSL).  
**Тестирование:** Pytest.

#### 4. Структура базы данных

![alt text](<images/db structure.png>)

#### 5. Структура кода

<pre>
helper-bot/
├── docker-compose.yml        # Оркестрация всех сервисов (бот, бэкенд, база данных, nginx) в виде контейнеров
├── .env.example              # Определение переменных окружения, необходимых всем сервисам
├── README.md                 
├── nginx/                    # Входной обратный прокси-сервер и слой терминации SSL
│   ├── nginx.conf            # Маршрутизация внешнего трафика к сервисам бота и бэкенда
│   └── ssl/                  # TLS-сертификаты для HTTPS / защищённых вебхуков
├── bot/                      # Сервис для взаимодействия с Telegram (уровень представления и взаимодействия)
│   ├── Dockerfile            # Сборка контейнера Telegram-бота
│   ├── requirements.txt      # Зависимости сервиса бота
│   ├── main.py               # Точка входа в приложение и инициализация бота
│   ├── config.py             # Конфигурация бота и загрузка переменных окружения
│   ├── handlers/             # Логика маршрутизации сообщений и взаимодействия с пользователем
│   │   ├── __init__.py
│   │   ├── start.py          # Обработка команд начала работы и онбординга
│   │   ├── chat.py           # Обработка пользовательских сообщений и чат-взаимодействий
│   │   ├── payments.py       # Инициация платёжных потоков и запросов пользователю
│   │   ├── profile.py        # Управление профилем пользователя и просмотром аккаунта
│   │   └── errors.py         # Централизованные ответы на ошибки для пользователя
│   ├── keyboards/            # UI-компоненты для взаимодействия в Telegram
│   │   ├── __init__.py
│   │   ├── main_menu.py      # Основные навигационные меню
│   │   └── payments.py       # Кнопки и меню, связанные с платежами
│   ├── middlewares/          # Скрещивающиеся аспекты, применяемые ко всем сообщениям
│   │   ├── __init__.py
│   │   ├── auth.py           # Проверка идентичности пользователя и валидности сессии
│   │   └── subscription.py   # Проверка ограничений подписки и пробного периода
│   ├── utils/                # Общие утилиты, используемые в сервисе бота
│   │   ├── __init__.py
│   │   ├── logger.py         # Логирование и диагностика для уровня бота
│   │   └── states.py         # Управление состоянием пользователя и определения FSM
│   └── tests/                # Автоматизированные тесты логики бота и промежуточного ПО
│       ├── __init__.py
│       ├── test_handlers.py
│       └── test_middlewares.py
├── backend/                  # Слой основной бизнес-логики и API
│   ├── Dockerfile            # Сборка контейнера сервиса бэкенда
│   ├── requirements.txt      # Зависимости бэкенда
│   ├── main.py               # Точка входа в бэкенд-приложение
│   ├── config.py             # Конфигурация бэкенда и загрузка переменных окружения
│   ├── api/                  # Конечные точки HTTP API, доступные боту и вебхукам
│   │   ├── __init__.py
│   │   ├── dependencies.py   # Общие зависимости API (аутентификация, сессии БД)
│   │   ├── webhook.py        # Обработка входящих вебхуков от Telegram или платёжных провайдеров
│   │   ├── process_message.py # Обработка сообщений, делегированных ботом
│   │   ├── credits.py        # Управление кредитами использования и квотами
│   │   ├── payments.py       # Конечные точки платежей и коллбэки
│   │   ├── users.py          # Конечные точки аккаунта пользователя и профиля
│   │   └── trial.py          # Жизненный цикл бесплатного пробного периода и валидация
│   ├── services/             # Уровень доменной и бизнес-логики
│   │   ├── __init__.py
│   │   ├── ai_service.py     # Оркестрация AI/LLM и логика инференса
│   │   ├── subscription_service.py # Управление состоянием подписки и тарифами
│   │   ├── payment_service.py # Логика интеграции с платёжным провайдером
│   │   └── user_service.py   # Бизнес-правила, связанные с пользователями
│   ├── models/               # Доменные модели и схемы данных
│   │   ├── __init__.py
│   │   ├── database.py       # Движок базы данных и базовые определения моделей
│   │   ├── schemas.py        # Схемы API и валидации
│   │   └── enums.py          # Общие перечисления для согласованности домена
│   ├── database/             # Уровень хранения и доступа к данным
│   │   ├── __init__.py
│   │   ├── session.py        # Управление сессиями и подключениями к базе данных
│   │   ├── crud.py           # Повторно используемые операции доступа к базе данных
│   │   └── migrations/       # Эволюция схемы и управление версиями
│   │       ├── versions/
│   │       └── alembic.ini
│   ├── utils/                # Общие утилиты для бэкенда
│   │   ├── __init__.py
│   │   ├── logger.py         # Логирование и мониторинг бэкенда
│   │   └── exceptions.py     # Централизованные определения ошибок
│   └── tests/                # Тесты компонентов бэкенда
│       ├── __init__.py
│       ├── test_api.py
│       ├── test_services.py
│       └── test_database.py
└── scripts/                  # Инструменты для эксплуатации и обслуживания
    ├── init_db.py            # Инициализация схемы базы данных и начальных данных
    ├── deploy.sh             # Скрипт автоматизации развёртывания
    └── backup.sh             # Скрипт резервного копирования и восстановления базы данных
</pre>

#### 6. План разработки и распределение задач

Dev 1 (Telegram Bot): Создаёт и поддерживает Telegram-бота, обрабатывает команды, инлайн-меню, промежуточное ПО (middleware) и интеграцию с бэкендом. [@Mahmadmurod](https://t.me/Mahmadmurod)

Dev 2 и TL (Backend): Реализует бэкенд на FastAPI, включая API-маршруты, интеграцию AI-сервисов, логику пробного периода и подписок, а также систему логирования. [@local_dan](https://t.me/local_dan)

Dev 3 (База данных): Проектирует, создаёт и управляет базой данных PostgreSQL, миграциями, асинхронными операциями и обеспечивает целостность данных. [@Ufpngh5](https://t.me/Ufpngh5)

Dev 4 (Инфраструктура и Платежи): Отвечает за развёртывание Docker, настройку Nginx и SSL, централизованное логирование и интеграцию Telegram Payments. [@ne_necoffeee](https://t.me/ne_necoffeee)

##### **Этап 1 — Базовый MVP**

###### **Dev 3 — База данных**

* PostgreSQL + Docker: 2ч
* Настройка Alembic: 2ч
* Создание таблиц (`users`, `trials`, `messages_log`): 3ч
* Конфигурация Async SQLAlchemy: 3ч
* Базовый CRUD: 2ч

###### **Dev 2 — Бэкенд**

* Настройка проекта FastAPI: 2ч
* Основные маршруты (`/register`, `/start_trial`, `/process_message`): 5ч
* Интеграция ИИ: 6ч
* Ограничения пробного периода и подсчёт сообщений: 3ч
* Обработка ошибок и логирование: 2ч


###### **Dev 1 — Telegram Бот**

* Регистрация бота через BotFather: 1ч
* Конфигурация вебхука: 2ч
* Команда `/start`: 2ч
* Инлайн-меню: 3ч
* Middleware (регистрация, проверка пробного периода): 4ч
* Отправка сообщений в бэкенд: 3ч

##### **Dev 4 — Инфраструктура**

* Docker Compose (бот, бэкенд, postgres): 3ч
* Nginx + SSL: 3ч
* Базовое логирование: 2ч
* Документация по развертыванию: 2ч

---

##### **Этап 2 — Полный функционал**

###### **Dev 3 — Улучшения базы данных**

* Дополнительные таблицы (`subscriptions`, `transactions`, `credits_history`): 3ч
* Индексы, ограничения: 2ч
* Запросы для кредитов и VIP: 2ч

### **Dev 2 — Улучшения бэкенда**

* Платежные эндпоинты и вебхук: 3ч
* Логика подписок: 3ч
* Повторные попытки / отказоустойчивость и обработка ошибок: 2ч
* Подключение лимитов использования ИИ: 2ч

### **Dev 1 — Улучшения Telegram Бота**

* UI для подписок: 3ч
* Интеграция платежей: 2ч
* Отображение статуса VIP/пробного периода: 2ч
* Улучшения UX и обработка ошибок: 2ч

### **Dev 4 — Улучшения инфраструктуры**

* Интеграция Telegram Payments: 3ч
* Полное логирование для бота/ИИ/платежей: 2ч
* Процедуры резервного копирования: 2ч
* Docker, готовый к CI/CD: 3ч

### **Этап 3: Тестирование и финальная интеграция**

**Все разработчики вместе:**
* Модульное и интеграционное тестирование: 4ч 
* Песочница для платежей (optional?): 2ч
* Сквозное тестирование и исправление ошибок: 4ч
* Финальное развертывание и документация: 2ч

#### Важное примечание:  
Исходный файл README был написан на английском языке и переведён на русский с помощью DeepSeek для экономии времени. Данное примечание добавлено для прозрачности.